<style>
    * {
        padding: none;
    }

    .container-camera {
        display: flex;
        flex-direction: column;
        max-width: 640px;
    }

    #webcam-feed {
        width: 640px;
    }

    .utilis-webcam {
        display: flex;
        flex-direction: row;
        justify-content: start;
        margin-top: 20px;
        gap: 20px;

    }

    .utilis-row-data{
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
        color: black;
        font-size: 21px;
        font-weight: 400;
        margin-bottom: 20px;
    }

    .utilis-row-data .row-data{
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 20px;
    }
</style>

<div class="container-camera">
    <img id="webcam-feed" alt="Webcam Feed" />
    <div class="utilis-row-data">
        <div class="row-data">
            <span>255</span>
            <span>255</span>
            <span>255</span>
        </div>
        <div class="row-data">
            <span>255</span>
            <span>255</span>
            <span>255</span>
        </div>
    </div>
    <div class="utilis-webcam">
        <button id="button-connect-camera" type="button" class="btn btn-success">On</button>
        <button id="button-disconnect-camera" type="button" class="btn btn-danger">Off</button>
        <button id="button-download-camera" type="button" class="btn btn-warning">Download</button>
    </div>

</div>

<script>
    let camera = null;
    const imgElement = $('#webcam-feed');
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const reconnectDelayMs = 2000;

    function connectCamera() {
        camera = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/api/get_image'
        );

        camera.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.message.image) {
                imgElement.attr('src', `data:image/jpeg;base64,${data.message.image}`);
            }
        };

        camera.onclose = function (e) {
            console.error('WebSocket closed unexpectedly', e);
            imgElement.hide();
            camera = null;

            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Reconnect attempt #${reconnectAttempts} in ${reconnectDelayMs / 1000} seconds...`);
                setTimeout(() => {
                    imgElement.show();
                    connectCamera();
                }, reconnectDelayMs);
            } else {
                console.warn('Max reconnect attempts reached. Stopping reconnect attempts.');
            }
        };

        camera.onerror = function (error) {
            console.error('WebSocket error observed:', error);
            camera.close();
        };

        camera.onopen = function () {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            imgElement.show();
        };
    }

    function saveUrlAsFile(url, fileName) {
        var link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.click();
    }

    $("#button-disconnect-camera").click(() => {
        if (camera !== null) {
            imgElement.hide();
            camera.close();
            camera = null;
            reconnectAttempts = maxReconnectAttempts;
        }
    });

    $("#button-connect-camera").click(() => {
        if (camera == null) {
            reconnectAttempts = 0;
            imgElement.show();
            connectCamera();
        }
    });

    $('#button-download-camera').click(() => {
        if (camera !== null) {
            saveUrlAsFile(imgElement.attr('src'), 'image.jpg');
        }
    });

    connectCamera();
</script>
<style>
    .container-camera {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
        padding: 20px;
    }

    .camera-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 2px solid #ccc;
        padding: 15px;
        border-radius: 12px;
        max-width: 640px;
    }

    .camera-block img {
        width: 640px;
        height: auto;
        border-radius: 8px;
    }

    .utilis-webcam {
        display: flex;
        gap: 15px;
        margin-top: 10px;
    }
</style>

<div class="container-camera" id="camera-container"></div>

<script>
    const cameraContainer = $('#camera-container');
    const cameraSockets = {};
    let mainSocket = null;

    function createCameraBlock(cameraId) {
        if ($(`#camera-block-${cameraId}`).length > 0) return;

        const block = $(`
            <div class="camera-block" id="camera-block-${cameraId}">
                <img id="camera-feed-${cameraId}" alt="Camera ${cameraId}" style="display: none;" />
                <div class="utilis-webcam">
                    <button class="btn btn-success" data-id="${cameraId}" data-action="connect">On</button>
                    <button class="btn btn-danger" data-id="${cameraId}" data-action="disconnect">Off</button>
                    <button class="btn btn-warning" data-id="${cameraId}" data-action="download">Download</button>
                </div>
            </div>
        `);
        cameraContainer.append(block);
    }

    function connectToCamera(cameraId) {
        $(`#camera-feed-${cameraId}`).show();
        cameraSockets[cameraId] = true; // Просто помечаем как активную
    }

    function disconnectCamera(cameraId) {
        delete cameraSockets[cameraId];
        $(`#camera-feed-${cameraId}`).hide();
    }

    function downloadCameraImage(cameraId) {
        const src = $(`#camera-feed-${cameraId}`).attr('src');
        const a = document.createElement('a');
        a.href = src;
        a.download = `camera-${cameraId}.jpg`;
        a.click();
    }

    $(document).on('click', '.utilis-webcam button', function () {
        const cameraId = $(this).data('id');
        const action = $(this).data('action');

        if (action === 'connect') connectToCamera(cameraId);
        else if (action === 'disconnect') disconnectCamera(cameraId);
        else if (action === 'download') downloadCameraImage(cameraId);
    });

    function startMainSocket() {
        mainSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/api/get_image'
        );

        mainSocket.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.type === 'camera_list') {
                data.cameras.forEach(id => createCameraBlock(id));
            } else if (data.message && data.message.camera !== undefined) {
                const camId = data.message.camera;
                if (cameraSockets[camId]) {
                    $(`#camera-feed-${camId}`).attr('src', `data:image/jpeg;base64,${data.message.image}`);
                }
            }
        };

        mainSocket.onclose = () => console.warn('Main socket closed');
    }

    startMainSocket();
</script>
